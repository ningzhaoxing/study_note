---

mindmap-plugin: basic

---

# 网络层

## 网络层概述
- 路由器
    - 既分割冲突域也分割广播域
    - 路由器的基本结构
        - 路由选择部分
            - 路由选择处理机
                - 更新路由表
        - 分组转发部分
            - 分组处理
                - 转发待转发的数据分组
                - 将路由报文送交路由选择处理机
            - 输入缓冲区
                - 新进入路由器，但来不及处理
            - 输出缓冲区
                - 已经处理完毕，但来不及发送
    - 基本功能
        - 对IP分组头进行差错校验，若发现错误将其丢弃
        - 检测到拥塞时，根据丢弃策略，合理丢弃IP分组
        - 根据IP分组的目的IP地址进行转发
        - 运行路由协议，构建路由表

## IPV4
- IPV4的分类编址
    - A:0~127
    - B:128.0~191.255
    - C:192.0.0~233.255.255
- IPV4的子网划分
    - VLSM可变子网掩码
    - CIDR无分类编址的IPV4地址
- 不可被指控给主机的IPV4地址
    - A类地址的0和127
    - 主机号全为0的网络地址
    - 主机号全为1的广播地址
    - D类(多播地址)、E类地址
- 首部格式
    - 组成
        - 固定部分(20字节)
            - 首部长度(占4比特)
                - 首部长度=首部长度取值*4 (字节)
            - 总长度(占16比特，表示IP数据包的总长度(首部+数据载荷))
            - 标识、片偏移
                - 负责IP数据包的分片
                - MTU数据包最大长度限制
            - 生存时间TTL
                - 8比特，为0则丢弃，否则转发
            - 协议
                - 8比特，知名IPv4数据包的数据部分时何种协议数据单元
            - 首部检验和
                - 16比特，检测首部在传输过程中是否出现差错
            - 源IP地址
                - 32比特
            - 目的IP地址
                - 32比特
        - 可变部分(40字节)
            - 填充字段(保证首部长度为4字节的整数倍，使用全0进行填充)
    - 以32个比特位单位描述
- 组成
    - 首部
    - 数据载荷

## IP数据报的发送与转发
- 过程
    - 判断源主机和目的主机是否在同一个网络中
        - 源主机所在网络地址：主机IP地址与子网掩码相与
        -
            - 目的主机所在网络地址：目的主机的IP地址与子网掩码相与
        - 判断两者是否相等
    - 默认网关
    - 聚合路由
        - 取共同前缀
        - 最长前缀匹配原则
- 静态路由配置
    - 默认路由
        - 目的网络为0.0.0.0/0
    -
        - 路由环路问题
            - 静态路由配置错误
                - 生存时间TTL
            - 不存在的网络导致路由环路问题
                - 添加黑洞路由

## 路由选择
- 静态路由协议
- 动态路由协议
    - 路由选择协议的分类
        - 内部网关协议IGP
            - 路由信息协议RIP
                - 基本工作原理
                    - 距离
                        - 路由器到直连网络的距离为1
                        - 路由器到非直连网络的距离为所经过的路由器数+1
                        - 距离16被定义为目的网络不可达
                    - 等价负载均衡
                        - 当到达同一网络有多条"距离相等“的路由时，可以进行等价负载均衡
                    - 三个要点
                        - who: 仅和相邻路由器交换信息
                        - what: 交换自己的路由表
                        - when: 周期性交换(例如每30s)
                    - 收敛
                        - 经过若干次交换和更新后，每个路由器都知道到达本AS内各网络的最短距离和下一眺地址
                    - 路由条目更新规则
                        - 到达目的网络，相同的下一眺，最新消息，更新
                        - 发现新的网络，添加
                        - 到达目的网络，不同的下一眺，新路由更近，更新
                        - 到达目的网络，不同的下一眺，等价负载均衡，添加
                    - 坏消息传得慢问题
                        - 出现路由环路，直到双方都直到目的网络不可达(收敛)
                        - 解决方法(减少危害)
                            - 限制最大路径距离为15
                            - 触发更新
                                - 当路由表发生变化时，就立即发送更新报文，而不是周期性发送
                            - 水平分割
                                - 让路由器记录收到某特定路由信息的接口，而不让同一路由信息再通过此接口反方向传送
                - 基于距离向量
            - 内部网关路由协议IGRP
            - 增强型内部网关路由协议EIGRP
            - 开放式最短路径有限OSPF
                - 基本工作原理
                    - 采用SPF最短路径算法，保证不会产生路由环路
                    - 不限制网络规模，更新效率高，收敛速度快
                    - 链路状态
                        - 与哪些路由器相邻
                        - 链路的"代价"
                    - 通过问候(Hello)分组，建立和维护邻居关系
                        - 分组装在IP数据报中，发往组播地址224.0.0.5
                        - 发送周期为10秒
                        - 若40秒未收到邻居路由器的Hello分组，则认为该邻居路由器不可达
                    - 基于链路状态
            - 中间系统到中间系统IS-IS
        - 外部网关协议EGP
            - 边界网关协议BGP
                - 基于路径向量

## 网际控制报文协议ICMP
- 基本信息
    - 为了更有效地转发IP数据包和提高交付成功地机会
    - 主机或路由器通过ICMP来发送差错报告报文和询问报文
    - ICMP报文被封装在IP数据包中发送
- ICMP差错报文
    - 终点不可达
    - 源点抑制
        - 网络拥塞
    - 时间超过
        - TTL生存时间
    - 参数问题
        - 首部校验出现误码
    - 改变路由(重定向)
    - 不发送ICMP差错报文的情况
        - 对ICMP差错报文
        - 对第一个分片之后后续的数据报文
        - 对具有多播地址的数据包
        - 对具有特殊地址(如127.0.0.0或0.0.0.0)
- ICMP询问报文
    - 回送请求和回答
        - 测试目的站是否可达
    - 时间戳请求和回答
        - 进行时钟同步和测量时间
- 应用
    - 分组网间探测PING
        - 测试所在网络和目的网络的连通性
    - 跟踪路由
        - 测试IP数据包从源主机到目的主机要经过哪些路由

## 提供的两种服务
- 面向连接的虚电路服务
    - 可靠通信由网络保证
    - 必须建立网络层的连接-虚电路VC
    - 通信双方沿着已建立的虚电路发送分组
    - 目的主机的地址仅在连接建立阶段使用，之后每个分组的首部只需携带一条虚电路的编号
    - 通信结束后，需要释放之前所建立的虚电路
    - 可靠性由网络来保证
- 无连接的数据包服务
    - 可靠通信应当由用户主机来保证
    - 不需要建立网络层连接
    - 每个分组可走不同路径
    - 每个分组的首部必须携带目的主机的完整地址
    - 分组可能误码，丢失，重复和失序

## ARP协议
- 作用:将IP地址解析为MAC地址
- ARP协议只能在一个链路或一个网络中使用，不能跨网络使用
- 工作原理
    - 首先根据目的主机的IP地址查询本主机的ARP高速缓存
    - 若找不到，则会发送ARP请求报文
    - 接收主机网卡会将广播MAC帧交付给上层处理，上层的ARP进程解析ARP报文，判断是否是发给自己的
    - 若是发给自己的
        - 该接收主机首先将发送主机的IP地址和MAC地址记录到自己的ARP高速缓存表中
        - 给目的主机发送ARP响应，以告知自己的MAC地址
    - 发送主机接收请求报文
        - 若非发送主机，接收到单播帧后发现与自己MAC地址不匹配，网卡直接丢弃
        - 若发送主机，网卡会将给上层ARP进程处理，将接收数据的IP地址与MAC地址记录到自己的ARP告诉缓存表中
- ARP报文
    - ARP请求报文
        - 被封装在MAC帧中发送，目的地址是广播地址FF-FF-FF-FF-FF-FF
    - APR响应报文
        - 被封装在MAC帧中发送，目的地址是发送主机的MAC地址
- ARP高速缓存
    - 由IP地址和MAC地址的映射构成的表
    - 动态
        - 自动获取，生命周期默认两分钟
    - 静态
        - 手工设置