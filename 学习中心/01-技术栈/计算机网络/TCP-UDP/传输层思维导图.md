---

mindmap-plugin: basic

---

# 传输层

## 传输层概述
- 端口
- 复用与分用
    - 发送方的复用
    - 接收方的分用

## UDP和TCP的对比
- 名称
    - UDP用户数据报协议
    - TCP传输控制协议
- 是否面向连接
    - TCP面向连接
    - UDP无连接
- 传播范围
    - UDP支持单播、多播和广播
    - TCP仅支持单播
- 传输方式
    - UDP面向应用报文
    - TCP面向字节流
- 可靠性
    - UDP向上层提供无连接不可靠的传输服务
    - 向上提供面向连接可靠传输服务
- 首部格式
    - UDP用户数据报首部仅包含8字节(源端口、目的端口、长度、校验和(各2字节))
    - TCP报文段首部最小20字节，最大60字节

## TCP
- 流量控制
    - 作用：让发送方的发送速率不要太快，让接收方来得及接收
    - 实现原理
        - 滑动窗口
        - 累计确认
    - AB互相等待的死锁局面
        - 原因:B向A发送了0窗口，A因此开始等待。B再向A发送非0窗口的报文段丢失，导致产生死锁。
        - 解决办法
            - 在发送方设置一个持续计时器，当收到0窗口报文段，则开始启动该计时器。当计时器超时，则向接收方发送一个零窗口探测报文，仅携带一字节数据。当对方接收到探测报文时，则给出自己现在的接收窗口值。
        - 若零窗口报文段也丢失
            - 设置一个零窗口重传计时器
- 拥塞控制
    - 解决网络中的拥塞问题，保证网络的输入负载
    - 网络拥塞
        - 对网络中某一资源的需求超过了该资源所能提供的可用部分，网络性能变坏。
        - 判断出现网络拥塞的依据
            - 没有按时收到应当到达的确认报文段(即发生超时重传)
        - 随着网络负载的增加，吞吐量反而降低
    - 四种拥塞控制算法
        - 慢开始
            - 拥塞窗口值成倍增加
        - 拥塞避免
            - 拥塞窗口值按线性增加
        - 快重传
            - 让发送方尽快进行重传，而不是等超时重传计时器超时重传
                - 要求接收方不要等待自己发送数据时才进行捎带确认，而是立即发送确认
                - 即使收到了失序的报文段也要立即发出对己收到的报文段的重复确认
                - 发送方一旦收到3个连续的重复确认，就将相应的报文段立即重传。
        - 快恢复
    - 拥塞控制的过程
        - 基本变量
            - 发送方
                - 拥塞窗口cwnd
                    - 取决于网络的拥塞程度，并且动态变化
                        - cwnd的维护原则:没有出现拥塞就增大一些；出现拥塞就减少一些
                - 发送窗口swnd
                    - 发送方将拥塞窗口作为发送窗口swnd，即swnd=cwnd
            - 慢开始门限ssthresh
        - 控制过程
            - 当cwnd < ssthresh：慢开始
            - cwnd > ssthresh：停止慢开始，使用拥塞避免算法
            - cwnd = ssthresh：既可以使用慢开始，也可以使用拥塞避免
            - 当发送方报文段丢失(即发生超时重传)
                - 则将ssthresh值更新未发生拥塞时cwnd值的一半
                - 将cwnd值减少为1，并重新开始执行慢开始算法
            - 当发送发收到3个连续的重复确认
                - 开始执行快重传、快恢复算法
                - 发送方将慢开始门限ssthresh值和cwnd值调整为当前窗口的一半，开始执行拥塞避免算法
                - 也有将拥塞窗口cwnd增大一些，等于新的ssthresh+3
- 可靠传输的实现
    - TCP基于以字节为单位的滑动窗口实现可靠传输
        - 发送窗口
            - 发送窗口与接收窗口保持一致
            - 窗口后沿
                - 不动(没有收到新的确认)
                - 前移(收到了新的确认)
            - 窗口前沿
                - 通常是不断向前移动
                - 不动
                    - 没有收到新的确认，对方通知的窗口大小也不变
                    - 收到新确认但对方通知的窗口缩小，使发送窗口前言正好不动
                - 向后收缩(对方通知的窗口缩小了)
            - 描述窗口状态
                - 使用三个指针P1,P2,P3
        - 接收窗口
    - 要求
        - 发送窗口和接收窗口不总是一样大
        - 对不按序到达的数据处理
            - 可以对不按序到达的数据进行丢弃
            - 可以临时存放在接收窗口中，等待确认字节收到后，再交付上层
        - 接收方必须有累计确认和捎带确认机制
- 连接管理
    - 连接建立
        - 需要解决的三个问题
            - 使TCP双方可以感知到双方的存在
            - 能够协商一些参数
            - 能够对运输实体资源进行分配
        - 三次握手
            - 客户端发送TCP连接请求
                - 同步位SYN = 1，seq=x
            - 服务端对客户端TCP请求进行确认
                - SYN=1,ACK=1,seq=y,ack=x+1
            - 客户端对服务端的确认进行确认
                - ACK=1,seq=x+1,ack=y+1
        - 采用三次握手而非二次握手的原因
            - 避免超时的TCP连接请求到达服务端后错误进入连接建立状态
        - SYN即使不携带数据，也会消耗掉一个序号
    - 连接释放
        - 四次挥手
            - 客户端进入终止等待状态，并发送TCP连接释放请求
                - FIN=1,ACK=1,seq=u,ack=v
            - 服务端进入等待关闭状态，并发送TCP普通确认报文段
                - ACK =1,seq=v,ack=u+1
                - 服务器向上层通告，并向客户端发送一些数据
                - 被动关闭连接
            - 服务端进入最后确认状态，并发送TCP连接释放确认报文段
                - FIN=1,ACK=1,seq=w,ack=u+1
            - 客户端进入时间等待状态，并发送TCP普通确认报文段
                - ACK=1,seq=u+1,ack=w+1
                - 服务端TCP连接进入关闭状态
                - 客户端TCP需要等待2MSL后进入关闭状态
        - MSL
            - 最长报文段寿命
        - 保活计时器
            - 避免客户端出现故障，导致连接无法释放的问题
            - 原理
                - TCP服务进程每收到一次TCP客户进程的数据，就重新设置并启动保活计时器(2小时定时)
                - 若保活计时器未在定时周期内接收到TCP客户进程发来的数据
                    - 则当保活计时器到时后，TCP服务器进程就向TCP发送一个探测报文段
                    - 每隔75秒发送一次，若一连发送10个探测报文段，仍无TCP客户进程响应，则关闭这个连接
- 首部格式
    - 固定首部(20字节)
        - 源端口号、目的端口号(各占16字节，总共32比特)
        - 序号(32比特)
            - 序号增加到最后一个，下一个序号回到0
            - 指出本TCP报文段数据载荷的第一个字节的序号
        - 确认号(32比特)
            - 序号增加到最后一个，下一个序号回到0
            - 期望收到下一个TCP报文段数据载荷的第一个字节的序号，同时也是对之前收到数据的确认
        - 其他字段(32比特)
            - 确认标志位ACK(占1比特)
                - 取值为1时有效，0无效
                - TCP规定，在建立连接后所有TCP报文段都必须把ACK置1
            - 同步标志位SYN
                - 建立连接时同步序号
            - 终止标志位FIN
                - 用来释放TCP连接
            - 复位标志位RST
                - 复位TCP连接。连接发生异常，需要重连
            - 推送标志位PSH
                - 通知接收方尽快上交应用进程
            - 紧急标志位URG
                - 表明紧急标志位是否有效
            - 数据偏移(4比特)
                - 指明TCP首部长度
                - 以4字节为单位
            - 保留(6比特)
            - 窗口(16比特，以字节为单位)
                - 指发送本报文段的一方的接收窗口
        - 校验和(16)、紧急指针(16)
    - 扩展首部(最大40字节)
        - 选项
        - 填充
            - 确保报文段首部能被4整除

## UDP
- 面向无连接的用户数据包协议
- 首部格式
    - 源端口号(2B)、目的端口号(2B)
    - UDP长度(2B)、检验和(2B)
- 伪首部(12字节)