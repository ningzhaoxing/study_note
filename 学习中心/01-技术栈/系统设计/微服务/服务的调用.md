![[20250228200635.png]]

# 微服务内跨层服务调用

前端应用调用发布在API 网关上的 Facade 服务，Facade 定向到应用服务。应用服务作为服务组织和编排者，它的服务调用有这样两种路径：

1. **应用服务调用并组装领域服务**。
	此时领域服务会组装实体和实体方法，实现核心领域逻辑。
	领域服务通过仓储服务获取持久化数据对象，完成实体数据初始化。

2. **应用服务直接调用仓储服务**。
	这种方式主要针对象缓存、文件等类型的基础层数据访问。
	这类数据主要是查询操作，没有太多的领域逻辑，不经过领域层，不涉及数据库持久化对象。

# 微服务之间的服务调用

微服务之间的应用服务可以直接访问，也可以通过 API 网关访问。
由于跨微服务操作，在进行数据新增和修改操作时，需关注分布式事务，保证数据的一致性。

# 领域事件驱动

**领域事件驱动包括微服务内和微服务之间的事件**。
微服务内通过事件*总线*（EventBus）完成聚合之间的异步处理。微服务之间通过*消息中间件*完成。
异步化的领域事件驱动机制是一种间接的服务访问方式。
当应用服务业务逻辑处理完成后，如果发生领域事件，可调用事件发布服务，完成事件发布。
当接收到订阅的主题数据时，事件订阅服务会调用事件处理领域服务，完成进一步的业务操作。

# 服务依赖

DDD 分层架构有一个重要的原则就是：**每层只能与位于其下方的层发生耦合**。

那根据耦合的紧密程度，分层架构可以分为两种：严格分层架构和松散分层架构。在严格分层架构中，任何层只能与位于其直接下方的层发生依赖。在松散分层架构中，任何层可以与其任意下方的层发生依赖。

在松散分层架构中，领域层的实体方法和领域服务可以直接暴露给应用层和用户接口层。松散分层架构的服务依赖关系，无需逐级封装，可以快速暴露给上层。
但它存在一些问题，第一个是容易暴露领域层核心业务的实现逻辑；第二个是当实体方法或领域服务发生服务变更时，由于服务同时被多层服务调用和组合，不容易找出哪些上层服务调用和组合了它，不方便通知到所有的服务调用方。

严格分层架构可以避免将核心业务逻辑的实现暴露给外部，将实体和方法封装成领域服务，也可以避免在应用层沉淀过多的本该属于领域层的核心业务逻辑，避免应用层变得臃肿。还有就是当服务发生变更时，由于服务只被紧邻上层的服务调用和组合，你只需要逐级告知紧邻上层就可以了，服务可管理性比松散分层架构要好是一定的。
