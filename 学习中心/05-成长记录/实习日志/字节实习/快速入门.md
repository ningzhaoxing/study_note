# 拉取框架

`go install -v code.byted.org/kite/kitex/tool/cmd/kitex@latest`

# 创建项目仓库

```shell
mkdir -p $GOPATH/code.byted.org/namespace/repos

cd $GOPATH/code.byted.org/namespace/repos

go mod init code.byted.org/namespace/repos
```

## Write IDL

```Shell
idl
├── base.thrift
└── service.thrift
```

```Thrift
namespace go p.s.m
include "base.thrift"

struct HelloRequest {
    1: required string Message,
    255: optional base.Base Base;
}
struct HelloResponse {
    1: required string Message,
    255: optional base.BaseResp BaseResp;
}
service GreetService {
    HelloResponse SayHello(1: HelloRequest request);
}
```

# 生成代码
## Server-side

```Bash
kitex -module code.byted.org/namespace/repos \
    -service p.s.m idl/service.thrift

# this is necessary since v0.14.0+ is not compatible with Kitex
# Refer to doc "not enough arguments" error for more information
go mod edit -replace=github.com/apache/thrift=github.com/apache/thrift@v0.13.0

go mod tidy
```

## Client-side

```shell
kitex -module code.byted.org/namespace/repos idl/service.thrift
```

# 业务实现

## Server-side

```Go
package main

import (
   "code.byted.org/kitex/kitex_example/kitex_gen/toutiao/kitex/demo"
   "context"
)

// GreetServiceImpl implements the last service interface defined in the IDL.
type GreetServiceImpl struct{}

// SayHello implements the GreetServiceImpl interface.
func (s *GreetServiceImpl) SayHello(ctx context.Context, request *demo.HelloRequest) (resp *demo.HelloResponse, err error) {
   // TODO: Your code here...
   return
}
```

## Client-side

```Go
package main

import (
   "code.byted.org/kite/kitex/client"
   "code.byted.org/kitex/kitex_example/kitex_gen/toutiao/kitex/demo"
   "code.byted.org/kitex/kitex_example/kitex_gen/toutiao/kitex/demo/greetservice"
   "context"
   "fmt"
)

func main() {
   var opts []client.Option
   // specify the address of the server
   opts = append(opts, client.WithHostPorts("localhost:8888"))
   // construct a client
   cli := greetservice.MustNewClient("kitex.thrift.example", opts...)
   ctx := context.Background()
   // initialize one request 
   req := &demo.HelloRequest{
      Message: "Hello",
   }

   // make a call
   resp, err := cli.SayHello(ctx, req)
   if err != nil {
      fmt.Printf("failed: %s\n", err.Error())
   } else {
      fmt.Printf("OK: %s\n", resp.Message)
   }
}
```

# 运行

## Server-side

```shell
go mod tidy

sh build.sh

sh output/bootstrap.sh
```

## Client-side

```shell
go run main.go
```